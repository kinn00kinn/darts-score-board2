# Darts Score Board システム構成書 📋

## 1. システム概要

### 1.1 プロジェクト概要
- 名称：Darts Score Board
- 目的：イベント（文化祭等）でのダーツスコア表示・演出システム
- 主要機能：スコア管理、ランキング表示、ガチャ演出、祝福演出
- 技術スタック：React + Vite

### 1.2 システムの特徴
- SPA（Single Page Application）アーキテクチャ
- ローカルストレージベースの永続化
- メディア（動画・音声）を活用した演出システム
- プレミアム/スタンダードの2段階ユーザー体験

## 2. 技術スタック詳細

### 2.1 フロントエンド
- **フレームワーク**: React 18
- **ビルドツール**: Vite
- **言語**: JavaScript (JSX)
- **スタイリング**: CSS Modules
- **状態管理**: React Hooks (useState, useEffect)
- **パッケージ管理**: npm

### 2.2 開発ツール
- **Linter**: ESLint
- **フォーマッター**: Prettier
- **ブラウザ開発ツール**: Chrome DevTools / Edge DevTools

## 3. システムアーキテクチャ

### 3.1 コンポーネント構造
```
App (メインコンテナ)
├── Leaderboard (スコアボード・入力)
│   └── EditPlayerModal (プレイヤー編集)
├── DartArea (ダーツボード表示)
├── GachaModal (ガチャ演出)
└── CelebrationOverlay (祝福演出)
```

### 3.2 データフロー
1. ユーザー入力 (`Leaderboard`)
   → スコア計算 (`scoreCalculator`)
   → 状態更新 (`App` state)
   → 演出トリガー (`GachaModal`/`CelebrationOverlay`)

2. 永続化フロー:
   状態更新 → localStorage保存 → 再読み込み時に復元

### 3.3 メディア管理
- **動画アセット**: `src/assets/videos/`
  - 形式: MP4 (H.264 + AAC)
  - ファイル: a.mp4, b.mp4, s.mp4
- **音声アセット**: `src/assets/sounds/`
  - 形式: MP3
  - ファイル: score-add.mp3, premium.mp3, fanfare.mp3, dart-hit.mp3

## 4. 主要機能詳細

### 4.1 スコア管理システム
- プレイヤーモデル:
  ```typescript
  interface Player {
    name: string;
    score: number;
    premium: boolean;
    lastUpdated: number;
  }
  ```
- スコア更新ロジック:
  - 新規プレイヤー: 作成してスコア設定
  - 既存プレイヤー: スコアを上書き

### 4.2 ガチャシステム
- トリガー: スコア追加/更新時
- 動画選定ロジック:
  ```javascript
  非プレミアム:
    score < 90      → b.mp4
    90 ≤ score < 140 → a.mp4
    score ≥ 140     → s.mp4
  プレミアム:
    score < 120     → a.mp4
    score ≥ 120     → s.mp4
  ```
- 再生制御:
  1. アンミュート再生試行
  2. ブロック時はミュート再生にフォールバック
  3. ユーザーによるアンミュート可能

### 4.3 祝福システム
- トリガー: ガチャ後のランク計算でTop3入り
- 演出要素:
  - ビジュアル: アニメーション付き順位表示
  - サウンド: ファンファーレ（fanfare.mp3）

### 4.4 プレミアムシステム
- UI: 豪華アニメーション付きトグルスイッチ
- 効果:
  - ガチャ動画の選定基準変更
  - 専用サウンド（premium.mp3）
- 状態管理: 追加操作後に自動リセット

## 5. パフォーマンス最適化

### 5.1 実装済み最適化
- メディアのバンドル（Viteによる最適化）
- コンポーネントの適切な分割
- 効率的なstate更新
- メモ化（useMemo）の活用

### 5.2 将来の最適化案
- メディアのプリロード
- レンダリングの最適化（React.memo）
- Web Workers活用の検討
- Service Worker導入検討

## 6. セキュリティ考慮事項

### 6.1 実装済みの対策
- localStorage利用時のJSON検証
- メディアソースの制限
- XSS対策（Reactの基本的な防御）

### 6.2 推奨される追加対策
- Content Security Policy導入
- メディアファイルの整合性チェック
- エラー境界の実装

## 7. テスト戦略

### 7.1 実装済みテスト
- ESLintによる静的解析
- 手動テスト手順書

### 7.2 推奨テスト追加
- ユニットテスト（Jest）
- コンポーネントテスト（React Testing Library）
- E2Eテスト（Cypress）

## 8. 運用保守

### 8.1 モニタリング項目
- ブラウザコンソールエラー
- メディア再生成功率
- ユーザー操作ログ

### 8.2 定期メンテナンス
- npm依存関係の更新
- ブラウザ互換性確認
- パフォーマンス計測

## 9. 今後の展開

### 9.1 短期改善案
- キーボード操作の完全対応
- アクセシビリティ改善
- エラーハンドリング強化

### 9.2 中長期計画
- オフライン対応（PWA）
- カスタムテーマ機能
- マルチプレイヤーモード

## 10. 開発フロー

### 10.1 ブランチ戦略
- main: プロダクション用
- develop: 開発用
- feature/*: 機能追加用

### 10.2 リリースプロセス
1. feature開発
2. developテスト
3. mainマージ
4. タグ付け（vX.Y.Z）

## 付録

### A. 環境構築手順
1. 依存関係インストール
   ```powershell
   npm install
   ```
2. 開発サーバー起動
   ```powershell
   npm run dev
   ```
3. ビルド
   ```powershell
   npm run build
   ```

### B. トラブルシューティングガイド
1. メディア再生問題
   - ブラウザポリシー確認
   - コーデック互換性確認
   - ネットワーク状態確認

2. パフォーマンス問題
   - DevToolsプロファイラー使用
   - メモリリーク調査
   - レンダリングボトルネック特定

### C. 用語集
- **ガチャ**: スコア入力後の演出システム
- **プレミアム**: 特別な動画が見られる課金的機能
- **祝福**: トップ3入賞時の特別演出

---

*最終更新: 2025年10月26日*
